---
title: "Fund Family Review"
output: html_notebook
---
Review performance and flows of an entire fund family.
Dodge & Cox, in this notebook.

Use tidyquant framework

```{r, message=FALSE, warning=FALSE}
devtools::install_github("business-science/tidyquant")
library(dplyr)
library(stringr)
library(Rblpapi)
library(knitr)
library(tidyverse)
library(scales)
library(reshape2)
library(PerformanceAnalytics)
library(ggrepel)
library(mFilter)
library(tidyquant)
```

Get the tickers of the relevant funds. 

This section will vary depending on the ticker  source. If you scrape the web site of the fund complex, each site will have a different layout. Parsing HTML is a dark art which I accomplish through frustrating trial and error.  It does have the advantage of being self-contained within the R script.

A simpler, though multi-step process is to use the Bloomberg fund screener to export a list of tickers.  In this example let's use the American Century Funds.

Type FSRC into the Bloomberg terminal.
Type "Investment Advisor" into the screening criteria box.
Click "Update."
Select "Include/Exclude"
Type the name of the desired fund company and choose from the dropdown list and hit return.
Click on "Results."
Click on "Output" and select "Excel"
Excel will load the file. 
Save as a csv file. "dodgecoxtickers.csv" in this example.


```{r, message=FALSE, warning=FALSE}

dodgecoxtickers <- read_csv("dodgecoxtickers.csv") #omit first row as it duplicates ```
```

Retrieve fund info and performance data.  Note we get most of the data elements in a single `tq_get/bdp` call.  Since we want `PEER RANKING` fields for both three and five years, we must call them separately since the field name is the same, must the overrides change and I don't know of a way to call multiple exclusive overrides at once.
```{r}
yearsAgo=10
#last day of the month preceeding the last full month yearsAgo
START_DATE=as.Date(as.yearmon(Sys.Date())-yearsAgo-1/12)-1

blpConnect()

secs<-dodgecoxtickers$ticker

# Get BBG Descriptive Data

Funds1<-tq_get(secs,get="rblpapi",rblpapi_fun="bdp",
       fields=c("NAME",
                "FUND_TOTAL_ASSETS",
                "FUND_BENCHMARK_PRIM",
                "FUND_MGR_STATED_FEE",
                "FUND_EXPENSE_RATIO",
                "DVD_FREQ",
                "CURRENT_ANN_TRR_3YR",
                "CURRENT_ANN_TRR_5YR"
                )
)


fund3yrRank<-tq_get(secs,get="rblpapi",rblpapi_fun="bdp",
                    fields="PEER_RANKING",
                    overrides=c("PEER_RANKING_PERIOD"='3Y')) %>% 
  mutate(PEER_RANKING=100-PEER_RANKING) %>% 
  rename(peer_rank_3Y=PEER_RANKING)

fund5yrRank<-tq_get(secs,get="rblpapi",rblpapi_fun="bdp",
                    fields="PEER_RANKING",
                    overrides=c("PEER_RANKING_PERIOD"='5Y')) %>% 
  mutate(PEER_RANKING=100-PEER_RANKING) %>% 
  rename(peer_rank_5Y=PEER_RANKING)
```
Assemble data set of fund snapshots.
```{r}

#---------------------------------------------------

Funds<-left_join(Funds1,fund3yrRank,by="symbol") %>% left_join(fund5yrRank,by="symbol")
# clean up names
Funds<-Funds %>% rename(Name=NAME,
                AUM=FUND_TOTAL_ASSETS,
                Benchmark=FUND_BENCHMARK_PRIM,
                Fee=FUND_MGR_STATED_FEE,
                Expense=FUND_EXPENSE_RATIO,
                DvdFreq=DVD_FREQ,
                Ret_3y=CURRENT_ANN_TRR_3YR,
                Ret_5y=CURRENT_ANN_TRR_5YR)
Funds<-Funds %>% separate(symbol,into=c("ticker","Domicile","sec_type"),remove=F)
#we don't distinguish share classes in this analysis so strip from names
shareClasses<-"(-A|-B|-C|-I|-R|-IS|-IV|-INV|-INST|-INS|-A1|-B2|-Y|-AUC|-E|-AU2)$"
Funds<-Funds %>% mutate(Name=str_replace(Name,shareClasses,"")%>%str_to_title())

#Save some space by removing company name from front of names
#We have to scan the Name field to see all the variations of the company name
mgrID<-'Dodge & Cox |Dodge Cox-|Dodge&Cox |Dodge & Cox-'
Funds<-Funds %>% mutate(Name=str_replace(Name,mgrID,'D&C '))
#sort by AUM
Funds<-Funds[order(Funds$AUM,decreasing = T),]

#Empty benchmark changed to MXWO
#edit to change if you wish
Funds[Funds$Benchmark=="",]$Benchmark="MXWO"
raw_Funds<-as_data_frame(edit(Funds))
nrow(raw_Funds)
```
This is a pretty long list.  For the purposes of this analysis let's discard funds that are less than $1000mm in size.

```{r}
#Remove funds with less than $1bn in AUM

Funds<-filter(raw_Funds,AUM>1000)

 #separate those funds that pay dividends monthly.  These are probably fixed income funds.
#Many fixed income funds declare dividends daily and, for whatever reason, BBG will
# return NA for  DAY_TO_DAY_TOT_RETURN_GROSS_DVDS on any frequency longer than DAILY.
#We could get daily data for all funds but that is a lot more data points than needed and
# we don't want to bust data caps, if any.
#This requires separate handling to convert daily periodicity to monthly.
#get monthly dividend funds at a daily frequency
secsD<-Funds %>% filter(DvdFreq=='Monthly') %>% pull(symbol)
#get non-monthly dividend funds at a monthly frequency
secsM<-Funds %>% filter(DvdFreq!='Monthly') %>% pull(symbol)

#create list of index tickers
ndxTicks<-Funds %>% 
  filter(Benchmark!="") %>% 
  transmute(Benchmark = paste(Benchmark,"INDEX")) %>% 
  unique() %>% 
  pull()

ndxTicks<-unique(c(ndxTicks,"LD12TRUU INDEX")) #don't add if it's already there
```
Get historical benchmark return data.
```{r}
BBG_FIELDS=c('PX_LAST','DAY_TO_DAY_TOT_RETURN_GROSS_DVDS')
BDH_OPTIONS = c("periodicitySelection"="MONTHLY")
rawDataNdx <-ndxTicks %>% 
  tq_get(get='rblpapi',
         rblpapi_fun='bdh',
         fields=BBG_FIELDS,
         start.date = START_DATE,
         end.date=Sys.Date(),
         options=BDH_OPTIONS
         ) %>%
  group_by(symbol)
```
Add wealth column and rename
```{r}
ndxRet<-rawDataNdx %>% 
  rename(Value=PX_LAST,Date=date) %>% 
  mutate(Return=DAY_TO_DAY_TOT_RETURN_GROSS_DVDS/100) %>% 
  mutate(Wealth=cumprod(1+Return)) %>% 
  separate(symbol,into="ticker",extra="drop") %>% 
  mutate(Name=ticker) %>% 
  select(ticker,Name,Date,Value,Return,Wealth)
head(ndxRet)
```



Get historical fund data. Use monthly frequency.  For bond funds, dividends are often declared daily. In these cases we need to get daily frequency and convert to monthly returns ourselves. We use a dividend frequency of monthly to indicate that we need to might need to fetch daily return data.

First, get the data at the right frequency.
```{r}
BBG_FIELDS=c('FUND_TOTAL_ASSETS','DAY_TO_DAY_TOT_RETURN_GROSS_DVDS')
# get funds that don't pay monthly dividends on a monthly frequency
BDH_OPTIONS = c("periodicitySelection"="MONTHLY")
rawDataM <-secsM %>% 
  tq_get(get='rblpapi',
         rblpapi_fun='bdh',
         fields=BBG_FIELDS,
         start.date = START_DATE,
         end.date=Sys.Date(),
         options=BDH_OPTIONS
         ) %>%
  group_by(symbol)

# get funds that pay monthly dividends on a daily frequency
#the monthly TRR number the bbg returns is wrong so we have to 
#get at daily frequency and convert it ourselves
BDH_OPTIONS = c("periodicitySelection"="DAILY")
rawDataD <-secsD %>% 
  tq_get(get='rblpapi',
         rblpapi_fun='bdh',
         fields=BBG_FIELDS,
         start.date = START_DATE,
         end.date=Sys.Date(),
         options=BDH_OPTIONS) %>%
  group_by(symbol) 


head(rawDataD)
head(rawDataM)
```
Now convert everything to monthly and join.

Start with funds where monthly frequency provides correct total return data to begin with.
```{r}
#rename and prepare to index returns as Wealth
#interpolate AUM where missing
aumretM<-rawDataM %>%
  group_by(symbol) %>% 
      mutate(Date=date,
            AUM=na.approx(FUND_TOTAL_ASSETS,na.rm=F),
            Return=DAY_TO_DAY_TOT_RETURN_GROSS_DVDS/100,
            Wealth=cumprod(1+DAY_TO_DAY_TOT_RETURN_GROSS_DVDS/100)
  ) %>% 
  select(symbol,Date,AUM,Return,Wealth)
```

Use daily returns for funds where monthly total return data is wrong due to daily accrual.  Convert to monthly.  Skip if no funds have have daily accrual (which is revealed by monthly dividend distributions in fixed income funds.)
```{r}
if (nrow(rawDataD)>0){
  #convert daily data to monthly returns
  #split out AUM and return data since no transformation needs to be done
  #to change AUM to a monthly frequency
  rawAumD<-rawDataD %>% 
    group_by(symbol) %>% 
    mutate(Date=date,
           AUM=na.approx(FUND_TOTAL_ASSETS,na.rm=F)
    ) %>% 
    select(symbol,Date,AUM)
  
  
  rawReturnsD<-rawDataD %>% 
    group_by(symbol) %>% 
    mutate(Date=date,
           Wealth=cumprod(1+DAY_TO_DAY_TOT_RETURN_GROSS_DVDS/100)
    ) %>% 
    select(symbol,Date,Wealth)
  
  
#compute monthly returns using tq_transmute and periodReturn from Quantmod package
  rawReturnsD <- rawReturnsD %>%  
    group_by(symbol) %>% 
    tq_transmute(select="Wealth",
                 mutate_fun=periodReturn,
                 period="monthly",
                 col_rename="Return") %>% 
    mutate(Wealth=cumprod(1+Return))
  
  aumretD<- rawReturnsD %>% 
    left_join(rawAumD,by=c("Date","symbol"))
  
  aumret<-bind_rows(aumretD,aumretM)
} else{
  aumret<-aumretM
}

#change symbol to bare ticker and long name
aumret<-aumret %>% 
  ungroup() %>% 
  left_join(select(Funds,symbol,ticker,Name),by='symbol') %>% 
  select(ticker,Name,Date,AUM,Return,Wealth) %>% 
  group_by(Name)

head(aumret)
```
Manual cleanup of some bad data.
```{r}
#missing terminal AUM for fund SOCGISD
#replace last full month AUM with static AUM data from bdp() function, rather than bdh()
#kind of ugly code
temp<-aumret[aumret$Date==as.Date("2017-10-31"),]
temp<-temp %>% select(-AUM) %>% 
  left_join(select(Funds,ticker,AUM),by="ticker") %>% 
  select(ticker,Name,Date,AUM,Return,Wealth)
aumret[aumret$Date==as.Date("2017-10-31"),]<-temp
#interpolate again
aumret<-aumret %>% group_by(ticker) %>% 
      mutate(AUM=na.approx(AUM,na.rm=F)
             )

```

Next we can impute flows from the change in AUM net of return.
```{r}
#impute flows from change in AUM net of return
flows<-aumret %>% 
  group_by(Name) %>% 
  mutate(flow=AUM-((1+Return)*lag(AUM))) %>% 
  mutate(flow=na.fill(flow,0)) %>% 
  mutate(cum_flow=cumsum(flow))
flows
```
#Family Assets Under Management

What does mutual fund AUM look like?
```{r, warning=FALSE}
gg<-aumret%>%
  #filter(Date>as.Date("200-01-01")) %>% 
  ggplot(aes(x=Date,y=AUM,fill=Name))+geom_col(width=40)
gg<- gg +ggtitle('Dodge & Cox Mutual Fund AUM')+xlab("Date")+ylab('Aum (mm)')
#gg<-gg+theme(legend.position = "none")
gg

```

#Family Flows

```{r}
gg<-flows %>% 
  filter(Date>as.Date("2009-01-01")) %>% 
  ggplot(aes(Date,flow,fill=Name))+geom_col()

gg<- gg +ggtitle('Imputed Flows')+xlab("Date")+ylab('Net Flow (mm)')
gg
```

#How do cumulative flows look?

```{r, warning=FALSE}
#create cumulative
cum_flows<-flows %>% 
  select(Date,Name,cum_flow) %>% 
  spread(Name,cum_flow) %>% 
  {.}

cum_flows$Total<-cum_flows %>% 
  select(-Date) %>% 
  apply(1,sum,na.rm=T)

gg<-  cum_flows %>% 
  ggplot(aes(x=Date, y=Total,fill="orange"))
gg<-gg<- gg +geom_col(width = 40)
gg<- gg + geom_abline(slope=0,intercept=0)
gg<- gg + ggtitle('Dodge and Cox Mutual Fund Cumulative Flows')+xlab("Date")+ylab('Net Flow (mm)')
gg<-gg+scale_fill_manual(values = c("orange"),guide=FALSE)
gg
```


What are the top flow gainers and losers over the last five years?

```{r, message=FALSE, warning=FALSE}
sum_flows<-flows %>% group_by(Name) %>% summarize(cum_flow=sum(flow)) 

sum_flows$Name<-factor(sum_flows$Name,
                       levels = sum_flows$Name[order(sum_flows$cum_flow,decreasing = F)])
gg<-ggplot(sum_flows,aes(x=Name,y=cum_flow))+geom_col(fill="orange")
gg<- gg +ggtitle('Dodge & Cox Flow Top Winners and losers')+ylab('Net 10-Year Flow (mm)')+xlab('Fund')+coord_flip()
gg
```

#Focus on the Biggest Fund

Interestingly, their biggest fund, Stock, has been flat in outflows. The fund is 5-Star, top decile performance over three years and the management team is long tenured.  How does it look over time?

```{r}
# use a Hodrick-Prescott filter to smooth the monthly data
#hpfilter(SGENX),freq=10,type = 'lambda')[2]$trend

gg<-flows %>% filter(ticker=='DODIX') %>% ggplot(aes(x=Date,y=cum_flow))

gg<- gg+geom_col(fill='orange') #+geom_smooth()
#gg<- gg+geom_smooth()

gg<-gg+geom_abline(slope=0,intercept=0)
gg<- gg +ggtitle('Dodge & Cox Stock Monthly Flows')+xlab("Date")+ylab('Net Flow (mm)')
gg

```
We can see the hangover from the financial crisis which coincided with team departures, but they have recovered since.
```{r}
filter(Funds,ticker=='DODGX')%>%select(starts_with('Peer'))
```
Performance has been  stellar of late vs. peers. How about vs. the benchmark, MSCI World?

#LIMIT OF CONVERSION
```{r}
# select fund benchmark and rebase.
fund<-'FE Global'
bench<-filter(Funds,Name==fund)$Benchmark
temp<-bind_rows(filter(aumret,Name==fund),filter(ndxRet,Name==bench))

gg<-ggplot(temp,aes(x=Date,y=Wealth,color=Name))+geom_line()
gg<-gg+ scale_colour_manual(values = c("orange", "black"))
gg<- gg +ggtitle(paste(fund,'vs.',bench))+xlab("Date")+ylab('Value of $1')
gg

```

Global has not been too bad during the past ten years but it's glory days were during the financial crisis.  How has it looked since the bottom?

Compare the tidy-ish code to the commented out xts/zoo code beneath it. Tidy code is much more parsimonious.  Though, to be fair, long-form tidy data feeds better into ggplot2.
```{r}
tempShort<-temp %>% filter(Date>as.Date('2009-02-01'))
#rebase wealth index
tempShort<-tempShort %>% mutate(Wealth=cumprod(1+Return))


# temp<-merge(fundRet[,fund],ndxRet[,bench])[-1]
# tempShort<-temp['200902/',]
# #ggplot2 likes to work with "long" data so turn the date index into a column in the data frame and "melt" it.
# dates<-as.Date(time(tempShort))
# tempShort<-as_data_frame(tempShort)
# tempShort<-cumprod(1+tempShort)
# tempShort$Date<-dates
# #transform to long form data arrangement
# tempShort<-melt(tempShort,id.vars = "Date")

gg<-ggplot(tempShort,aes(x=Date,y=Wealth,color=Name))+geom_line()
gg<-gg+ scale_colour_manual(values = c("orange", "black"))
gg<- gg +ggtitle(paste(fund,'vs.',bench))+xlab("Date")+ylab('Value of $1')
gg

```

#Peer Group Rankings

Now let's look at the broader complex.  Bloomberg has  it's own peer group rankings.  They are not going to be the same as Morningstar or Lipper but I have found they line up pretty closely.  There may be some categories that don't line up so compare before assuming for any specific fund.

First look at the distribution of quartile ranks by number of funds. A lower quartile number is better.  Cool visualization.

```{r}
#create quartile ranks
qr<-data_frame(Name=Funds$Name,
               AUM=Funds$AUM,
               ThreeYr=as.factor(trunc(Funds$peer_rank_3Y/100*4+1)),
               FiveYr=as.factor(trunc(Funds$peer_rank_5Y/100*4+1)))
#convert period columns into factors and get rid of funds with missing data
qr<-melt(qr,id=c('Name','AUM'),
         measure.vars=c("ThreeYr","FiveYr"),
         variable.name = 'Period',value.name = "Quartile")%>%na.omit()
lb<-labs(title='Fund Family Quartile Rankings',
         x='Period',
         caption='Bloomberg defined peer groups')

ggplot(qr,aes(x=Period))+
  geom_bar(aes(weight=1/nrow(qr)*2,fill=Quartile))+lb+ylab("Fraction of Funds")+
  scale_y_continuous(labels=comma)+
  scale_fill_manual(values=c("DarkGreen","LightGreen","Orange","Red"))
  #scale_fill_brewer(palette = "RdYlGn",direction=-1)
```
Now look at the distribution weighted by AUM

```{r}

ggplot(qr,aes(x=Period))+
  geom_bar(aes(weight=AUM/sum(AUM)*2,fill=Quartile))+lb+ylab("Fraction of AUM")+
  scale_y_continuous(labels=comma)+
  scale_fill_manual(values=c("DarkGreen","LightGreen","Orange","Red"))

```
The three year rankings look better than than the five year. The difference between the by-fund and the by-AUM perspectives means that a few jumbo funds are driving performance of the whole family.

# Performance vs. Benchmarks

Active managers are challenged to beat, not just their peers, but their index benchmarks.  Let's take a couple perspectives on that.  
```{r}
t<-cumprod(1+xts::last(ndxRet,'3 years'))%>%xts::last()-1
base::t(as.data.frame(t))
```


Downside protection is a key attribute advisors focus on. 
